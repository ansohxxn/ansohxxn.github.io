---
title:  "Unity Chapter 11-10. ì¢€ë¹„ TPS ê²Œì„ ë§Œë“¤ê¸° : PlayerShooter" 

categories:
  -  Unity Lesson 1 
tags:
  - [Game Engine, Unity]

toc: true
toc_sticky: true

date: 2020-08-15
last_modified_at: 2020-08-15
---

ì¸í”„ëŸ°ì— ìˆëŠ” ì´ì œë¯¼ë‹˜ì˜ **ë ˆíŠ¸ë¡œì˜ ìœ ë‹ˆí‹° C# ê²Œì„ í”„ë¡œê·¸ë˜ë° ì—ì„¼ìŠ¤** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤. ğŸ˜€  
[ğŸŒœ [ë ˆíŠ¸ë¡œì˜ ìœ ë‹ˆí‹° C# ê²Œì„ í”„ë¡œê·¸ë˜ë° ì—ì„¼ìŠ¤] ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸°!](https://www.inflearn.com/course/%EC%9C%A0%EB%8B%88%ED%8B%B0-%EA%B2%8C%EC%9E%84-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EC%97%90%EC%84%BC%EC%8A%A4)
{: .notice--warning}

<br>

# Chapter 11. ì¢€ë¹„ TPS ê²Œì„ ë§Œë“¤ê¸° 

## ğŸ“œPlayerShooter.cs

> `Player` ì˜¤ë¸Œì íŠ¸ì— ë¶™ì¸ë‹¤.

- **ì—­í• **
  1. `Player Character`ì˜ ì…ë ¥ì— ë”°ë¼ ì´ì„ ì˜ê±°ë‚˜ ì¬ì¥ì „ í•œë‹¤.
  2. ì•Œë§ì€ ì• ë‹ˆë©”ì´ì…˜ì„ ì¬ìƒí•˜ê³  IKë¥¼ ì‚¬ìš©í•´ `Player Character` ì™¼ì†ì˜ ìœ„ì¹˜ê°€ ì´ì˜ ì™¼ì† ì†ì¡ì´ì— ìœ„ì¹˜í•˜ë„ë¡ ê°±ì‹ í•œë‹¤.

```c#
using UnityEngine;

// ì£¼ì–´ì§„ Gun ì˜¤ë¸Œì íŠ¸ë¥¼ ì˜ê±°ë‚˜ ì¬ì¥ì „
// ì•Œë§ì€ ì• ë‹ˆë©”ì´ì…˜ì„ ì¬ìƒí•˜ê³  IKë¥¼ ì‚¬ìš©í•´ ìºë¦­í„° ì–‘ì†ì´ ì´ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì •
public class PlayerShooter : MonoBehaviour
{
    public enum AimState
    {
        Idle,
        HipFire
    }

    public AimState aimState { get; private set; }

    public Gun gun; // ì‚¬ìš©í•  ì´
    public LayerMask excludeTarget;

    private PlayerInput playerInput;
    private Animator playerAnimator; // ì• ë‹ˆë©”ì´í„° ì»´í¬ë„ŒíŠ¸
    private Camera playerCamera;

    private Vector3 aimPoint;
    private bool linedUp => !(Mathf.Abs(playerCamera.transform.eulerAngles.y - transform.eulerAngles.y) > 1f);
    private bool hasEnoughDistance => !Physics.Linecast(transform.position + Vector3.up * gun.fireTransform.position.y, gun.fireTransform.position, ~excludeTarget);

    void Awake()
    {
        if (excludeTarget != (excludeTarget | (1 << gameObject.layer)))
        {
            excludeTarget |= 1 << gameObject.layer;
        }
    }

    private void Start()
    {
        playerCamera = Camera.main;
        playerInput = GetComponent<PlayerInput>();
        playerAnimator = GetComponent<Animator>();
    }

    private void OnEnable()
    {
        gun.gameObject.SetActive(true);
        gun.Setup(this);
    }

    private void OnDisable()
    {
        gun.gameObject.SetActive(false);
    }

    private void FixedUpdate()
    {
        if (playerInput.fire)
        {
            Shoot();
        }
        else if (playerInput.reload)
        {
            Reload();
        }
    }

    private void Update()
    {
        UpdateAimTarget();

        var angle = playerCamera.transform.eulerAngles.x;
        if (angle > 270f) angle -= 360f;

        angle = angle / 180f * -1f + 0.5f;

        playerAnimator.SetFloat("Angle", angle);

        UpdateUI();
    }

    public void Shoot()
    {
        if (aimState == AimState.Idle)
        {
            if (linedUp) aimState = AimState.HipFire;
        }
        else if (aimState == AimState.HipFire)
        {
            if (hasEnoughDistance)
            {
                if (gun.Fire(aimPoint)) playerAnimator.SetTrigger("Shoot");
            }
            else
            {
                aimState = AimState.Idle;
            }
        }
    }

    public void Reload()
    {
        // ì¬ì¥ì „ ì…ë ¥ ê°ì§€ì‹œ ì¬ì¥ì „
        if (gun.Reload()) playerAnimator.SetTrigger("Reload");
    }

    private void UpdateAimTarget()
    {
        RaycastHit hit;

        var ray = playerCamera.ViewportPointToRay(new Vector3(0.5f, 0.5f, 1f));

        if (Physics.Raycast(ray, out hit, gun.fireDistance, ~excludeTarget))
        {
            aimPoint = hit.point;

            if (Physics.Linecast(gun.fireTransform.position, hit.point, out hit, ~excludeTarget))
            {
                aimPoint = hit.point;
            }
        }
        else
        {
            aimPoint = playerCamera.transform.position + playerCamera.transform.forward * gun.fireDistance;
        }
    }

    // íƒ„ì•½ UI ê°±ì‹ 
    private void UpdateUI()
    {
        if (gun == null || UIManager.Instance == null) return;

        // UI ë§¤ë‹ˆì €ì˜ íƒ„ì•½ í…ìŠ¤íŠ¸ì— íƒ„ì°½ì˜ íƒ„ì•½ê³¼ ë‚¨ì€ ì „ì²´ íƒ„ì•½ì„ í‘œì‹œ
        UIManager.Instance.UpdateAmmoText(gun.magAmmo, gun.ammoRemain);

        UIManager.Instance.SetActiveCrosshair(hasEnoughDistance);
        UIManager.Instance.UpdateCrossHairPosition(aimPoint);
    }

    // ì• ë‹ˆë©”ì´í„°ì˜ IK ê°±ì‹ 
    private void OnAnimatorIK(int layerIndex)
    {
        if (gun == null || gun.state == Gun.State.Reloading) return;

        // IKë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¼ì†ì˜ ìœ„ì¹˜ì™€ íšŒì „ì„ ì´ì˜ ì˜¤ë¥¸ìª½ ì†ì¡ì´ì— ë§ì¶˜ë‹¤
        playerAnimator.SetIKPositionWeight(AvatarIKGoal.LeftHand, 1.0f);
        playerAnimator.SetIKRotationWeight(AvatarIKGoal.LeftHand, 1.0f);

        playerAnimator.SetIKPosition(AvatarIKGoal.LeftHand, gun.leftHandMount.position);
        playerAnimator.SetIKRotation(AvatarIKGoal.LeftHand, gun.leftHandMount.rotation);
    }
}
```

<br>

### ë©¤ë²„ ë³€ìˆ˜ & í”„ë¡œí¼í‹°

```c#
    public enum AimState
    {
        Idle,
        HipFire
    }

    public AimState aimState { get; private set; }

    public Gun gun; // ì‚¬ìš©í•  ì´
    public LayerMask excludeTarget;

    private PlayerInput playerInput;
    private Animator playerAnimator; // ì• ë‹ˆë©”ì´í„° ì»´í¬ë„ŒíŠ¸
    private Camera playerCamera;

    private Vector3 aimPoint;
    private bool linedUp => !(Mathf.Abs(playerCamera.transform.eulerAngles.y - transform.eulerAngles.y) > 1f);
    private bool hasEnoughDistance => !Physics.Linecast(transform.position + Vector3.up * gun.fireTransform.position.y, gun.fireTransform.position, ~excludeTarget);
```

- `aimState`
  - 2 ê°€ì§€ ìƒíƒœ
    1. `Idle` : ë¬´ê¸° ì‚¬ìš© X 
    2. `HipFire` : ë°œì‚¬ (ì¡°ì¤€ ì—†ì´ ê²¬ì°© ë°œì‚¬)
  - í”„ë¡œí¼í‹°ë¥¼ í†µí•˜ì—¬ *get*ì€ public, *set*ì€ privateìœ¼ë¡œ í•´ë‘ì—ˆë‹¤.  
    - ğŸ“œPlayerShooter ë‚´ë¶€ì—ì„œë§Œ ìƒíƒœ ê°’ì„ ë³€ê²½í•  ìˆ˜ ìˆê³  ì™¸ë¶€ì—ì„œë§Œ ë³€ê²½ ë¶ˆê°€ëŠ¥ í•˜ê³  ê°’ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒë§Œ ê°€ëŠ¥í•˜ê²Œë”.
  - ë³´í†µ TPS ê²Œì„ì—ì„  3 ê°€ì§€ ì—ì„ ìƒíƒœë¥¼ ê°€ì§€ëŠ”ë° ì—¬ê¸°ì„  2 ê°€ì§€ë§Œ ë‹¤ë£¸
    - ğŸ‘‰ ê°€ë§Œíˆ ìˆê¸°, ì¡°ì¤€ ì—†ì´ ë°œì‚¬(ê²¬ì°©), ì •ì¡°ì¤€ ë°œì‚¬
  - ë”°ë¡œ ì—ì„ ìƒíƒœ `aimState`ë¥¼ êµ¬ë¶„ í•˜ëŠ” ì´ìœ 
    - <u>ì¡°ì¤€ ìƒíƒœì¼ ë•ŒëŠ” ë¬´ì¡°ê±´ í”Œë ˆì´ì–´ê°€ ì¡°ì¤€í•˜ê³  ìˆëŠ” ë°©í–¥ê³¼ ì¹´ë©”ë¼ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ì´ ì¼ì¹˜í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì—</u> í”Œë ˆì´ì–´ì˜ ë°©í–¥ì„ ì¹´ë©”ë¼ì˜ ë°©í–¥ê³¼ ì¼ì¹˜ì‹œì¼œ ì£¼ì–´ì•¼ í•œë‹¤.
      - ì´ì„ ì‚¬ìš©í•˜ëŠ” ìƒíƒœê°€ ì•„ë‹ ë•ŒëŠ” í”Œë ˆì´ì–´ê°€ ì¹´ë©”ë¼ì˜ ë°©í–¥ê³¼ ì¼ì¹˜í•  í•„ìš”ê°€ ì—†ë‹¤. 
- `gun`
  - ğŸ“œ**Gun** íƒ€ì…
- `excludeTarget`
  - **LayerMask** íƒ€ì…ìœ¼ë¡œ ì¡°ì¤€ì—ì„œ ì œì™¸í•  ë ˆì´ì–´ë“¤ì„ í• ë‹¹í•  ë ˆì´ì–´ ë§ˆìŠ¤í¬ 
- í”Œë ˆì´ì–´
  - `playerInput`
    - ğŸ“œ**PlayerInput** íƒ€ì…ìœ¼ë¡œ í”Œë ˆì´ì–´ ì…ë ¥ ì •ë³´ë¥¼ ì „ë‹¬
  - `playerAnimator` 
    - **Animator**ë¡œ, ì™¼ì† IKë¥¼ í†µí•´ ì´ì˜ ì™¼ì†ì¡ì´ì— ë‘ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— í•„ìš”í•œ `Player Character`ì˜ ì• ë‹ˆë©”ì´í„° ì»´í¬ë„ŒíŠ¸
- ì¹´ë©”ë¼
  - `playerCamera`
    - ë©”ì¸ ì¹´ë©”ë¼ê°€ í• ë‹¹ ë  ê³³
- `aimPoint`
  - ì‹¤ì œë¡œ ì¡°ì¤€í•˜ê³  ìˆëŠ” ëŒ€ìƒì˜ ìœ„ì¹˜ 
    - TPSê°€ ì•„ë‹Œ 1ì¸ì¹­ì¸ FPSë¥¼ ë§Œë“¤ ë•ŒëŠ” ì´ê²Œ í•„ìš” ì—†ë‹¤. FPS ì—ì„œëŠ” ì¹´ë©”ë¼ í™”ë©´ ì •ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ì„ ë°œì‚¬í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì—!
    - FPSì™€ ë‹¬ë¦¬ <u>TPSì—ì„œëŠ” ì‹¤ì œë¡œ ì¡°ì¤€í•œ ê²½ìš°ë¡œ ë‚ ì•„ê°€ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ë°œìƒí•œë‹¤. ê²½ìš°ì— ë”°ë¼ì„œëŠ” ì¹´ë©”ë¼ í™”ë©´ ì •ì¤‘ì•™ìœ¼ë¡œ ë°œì‚¬í•  ìˆ˜ ì—†ë‹¤</u>
      - ![image](https://user-images.githubusercontent.com/42318591/90259130-7ea4cb80-de84-11ea-8cdb-287facd2f574.png){: width="70%" height="70%"}{: .align-center}
        - ìœ„ ê·¸ë¦¼ìœ¼ë¡œ ë´¤ì„ ë•Œ ì‹¤ì œë¡œ í”Œë ˆì´ì–´ì˜ `Gun`ì˜ ìœ„ì¹˜ë¡œ ë´¤ì„ ë•Œ í”Œë ˆì´ì–´ ë°”ë¡œ ì•ì— ìˆëŠ” ë¹¨ê°„ ë²½ì— ì´ì•Œì´ ë§ì•„ì•¼ í•˜ëŠ”ë° ì¹´ë©”ë¼ì˜ ì •ì¤‘ì•™ì—ì„œ ì˜ëŠ” ë ˆì´ìºìŠ¤íŠ¸ë¡œëŠ” ë’¤ì— ìˆëŠ” ë²½ì— ë§ê²Œ ëœë‹¤.
        - ë”°ë¼ì„œ FPSì™€ ë‹¬ë¦¬ <u>TPS ì—ì„œëŠ” í•­ìƒ ì¹´ë©”ë¼ ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ì˜ì•„ì§€ëŠ” ì¡°ì¤€ì ì´ ì •ë‹µì´ ì•„ë‹Œ ê²½ìš°ê°€ ìˆê¸° ë•Œë¬¸ì— ì‹¤ì œë¡œ ì´ì•Œì´ ë§ì•„ì•¼ í•˜ëŠ” ìœ„ì¹˜ë¥¼ ë”°ë¡œ ì €ì¥í•´ë‘ì–´ì•¼ í•œë‹¤.</u> 
  - ë”°ë¼ì„œ TPSì—ì„œëŠ” <u>ì¡°ì¤€ì ì„ 2 ê°œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.</u>
    1. ì‹¤ì œë¡œ `Player Character` ì…ì¥ì—ì„œ ì¡°ì¤€í•œ, ì´ì•Œì´ ë§ì•„ì•¼í•  ì¡°ì¤€ì  `aimPoint`
    2. ì¹´ë©”ë¼(í™”ë©´) ì •ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ ì¡°ì¤€ì 
- `linedUp`
  - `Player Character`ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ê³¼ `playerCamera` ì¹´ë©”ë¼ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ ì‚¬ì´ì˜ y ì¶• íšŒì „ê°’ ì‚¬ì´ì˜ ê°ë„ê°€ ë„ˆë¬´ ë²Œì–´ì¡ŒëŠ”ì§€ ë²Œì–´ì§€ì§€ ì•Šì•˜ëŠ”ì§€ë¥¼ bool íƒ€ì…ìœ¼ë¡œ ë¦¬í„´í•´ì£¼ëŠ” í”„ë¡œí¼í‹°
    - yì¶• ê°ë„ ì°¨ì´ê°€ 1ë„ ì´ìƒì´ë©´ falseë¦¬í„´
    - yì¶• ê°ë„ ì°¨ì´ê°€ 1ë„ ì´í•˜ë©´ true ë¦¬í„´
    - ëŒë‹¤ í•¨ìˆ˜ë¡œ ì •ì˜ëœ í”„ë¡œí¼í‹°ë‹¤.
  - `Player Character`ëŠ” ì¹´ë©”ë¼ ì…ì¥ì—ì„œ ì™¼ìª½ì„ ë°”ë¼ë³´ê³  ìˆë‹¤ë©´ ì´ì„ ì˜ë©´ ì•ˆë¨.
    - ì´ì„ ì˜ëŠ” ëŒ€ì‹ ì—, ë°œì‚¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ìˆëŠ” ë™ì•ˆ `Player Character`ê°€ ì¹´ë©”ë¼ ë°©í–¥ìœ¼ë¡œ ì •ë ¬ ë˜ê²Œ í•´ì•¼ í•œë‹¤.
- `hasEnoughDistance`
  - `Player Character`ê°€ ì •ë©´ì— ì´ì„ ë°œì‚¬í•  ìˆ˜ ìˆì„ ì •ë„ì˜ ë„‰ë„‰í•œ ê³µê°„ì„ í™•ë³´í•˜ê³  ìˆëŠ”ì§€ë¥¼ ë¦¬í„´í•˜ëŠ” í”„ë¡œí¼í‹°
    - `Player Character`ê°€ ë„ˆë¬´ ë²½ì— ê°€ê¹Œì´ ë¶™ì–´ìˆìœ¼ë©´ ì´êµ¬ê°€ ë²½ì— íŒŒë¬»íˆê²Œ ë˜ë‹ˆê¹Œ ì´ëŸ° ìƒí™©ì—ì„  ì´ì´ ë°œì‚¬ë˜ì§€ ì•Šë„ë¡ í•  ê²ƒ.
  - ***Physics Linecast***
    - ë¼ì¸ìºìŠ¤íŠ¸. ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ê´‘ì„ ì„ ì´ì„œ ë¬¼ë¦¬ì  ì¶©ëŒì„ ê°ì§€í•œë‹¤.
      - Raycast ì™€ì˜ ì°¨ì´ì  
        - ğŸ‘‰ LinecastëŠ” ì •í™•í•œ ì¢…ë£Œ ì§€ì ì„ ì•Œ ë•Œ, RaycastëŠ” ë°©í–¥ë§Œ ì•Œ ë•Œ ì‚¬ìš©! 
    - Linecast ì‹œì‘ ì§€ì 
      - *transform.position + Vector3.up * gun.fireTransform.position.y*
        - í˜„ì¬ ìœ„ì¹˜(= `Player Character`ì˜ ë°œğŸ¦¶)ë¡œë¶€í„° ì´ì˜ ë°œì‚¬êµ¬ ìœ„ì¹˜ì˜ y ê°’ì— ìœ„ìª½ ë°©í–¥ ë²¡í„°ë¥¼ ê³±í•´ì¤€ ë§Œí¼ì„ ë”í•´ì¤€ë‹¤.
          - ì¦‰ í”Œë ˆì´ì–´ì˜ ë°œ ìœ„ì¹˜ì—ì„œ ì´ì˜ ë°œì‚¬êµ¬ì˜ yë°©í–¥ì˜ ê±°ë¦¬ë²¡í„°ë§Œí¼ì„ ìœ„ë¡œ ë”í•´ì„œ Linecast ì‹œì‘ ìœ„ì¹˜ë¥¼ ë†’í˜€ì¤€ ê²ƒ!
            - <u>ì¦‰, Linecastì˜ ì‹œì‘ ì§€ì ì€ ê°œë¨¸ë¦¬ íŒì´ ìˆëŠ” í”Œë ˆì´ì–´ì˜ ê°€ìŠ´ ì •ë„ ìœ„ì¹˜ì— í•´ë‹¹ë˜ê²Œ ëœë‹¤.</u>
    - Linecast ì¢…ë£Œ ì§€ì 
      - *gun.fireTransform.position*
        - ì´ì˜ ë°œì‚¬êµ¬ ìœ„ì¹˜
    - `~excludeTarget` 
      - ë§ˆì°¬ê°€ì§€ë¡œ ì¡°ì¤€ ëŒ€ìƒì´ ì•„ë‹Œ ë ˆì´ì–´ë“¤ì€ ì²˜ë¦¬ ëŒ€ìƒì—ì„œ ì œì™¸í–ˆë‹¤.
  - ![image](https://user-images.githubusercontent.com/42318591/90263767-12799600-de8b-11ea-8b20-28ccd226ca95.png){: width="70%" height="70%"}{: .align-center}
    - **ë¼ì¸ ìºìŠ¤íŠ¸ ë²”ìœ„ëŠ” ëŒ€ì¶© í”Œë ˆì´ì–´ì˜ ê°€ìŠ´ìœ¼ë¡œë¶€í„° ì´ì˜ ë°œì‚¬êµ¬ ê¹Œì§€ê°€ ëœë‹¤.**
    - <u>ì´ ë¶€ë¶„ì— ì–´ë–¤ ì¶©ëŒì´ ì¼ì–´ë‚˜ê²Œ ëœë‹¤ë©´, ì¦‰ ì´ ë¶€ë¶„ì´ ë²½ ê°™ì€ ê³³ì— íŒŒë¬»íˆê²Œ ë˜ì–´</u> falseê°€ `hasEnoughDistance`ì— ë¦¬í„´ëœë‹¤ë©´ ì´ì´ íŒŒë¬»í˜”ë‹¤ëŠ” ëœ»ì´ë¯€ë¡œ ë°œì‚¬ê°€ ë˜ì§€ ì•Šê²Œë” í•  ê²ƒì´ë‹¤.
      - `!`ê°€ ë¶™ì–´ìˆì–´ bool íƒ€ì… ë°˜ëŒ€ëœ ê²ƒì— ì£¼ì˜í•˜ê¸°

<br>

### ë©¤ë²„ í•¨ìˆ˜

#### void Awake()

> `excludeTarget`ì— `Player Character`ì˜ ë ˆì´ì–´ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ `Player Character`ì˜ ë ˆì´ì–´ë¥¼ `excludeTarget`ì— ì¶”ê°€í•˜ëŠ” ì—°ì‚°ì„ ìˆ˜í–‰í•œë‹¤.

- ë¹„íŠ¸ ì—°ì‚°ì„ í†µí•´ `excludeTarget`ì— ë ˆì´ì–´ë¥¼ ì¶”ê°€
  - [C++ ë¹„íŠ¸ ì—°ì‚°, ë¹„íŠ¸ í”Œë˜ê·¸, ë¹„íŠ¸ ë§ˆìŠ¤í¬ í¬ìŠ¤íŠ¸ ì°¸ê³ ](https://ansohxxn.github.io/cpp/chapter3-3/#%EB%B9%84%ED%8A%B8%ED%94%8C%EB%9E%98%EA%B7%B8%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0)


```c#
    void Awake()
    {
        if (excludeTarget != (excludeTarget | (1 << gameObject.layer)))
        {
            excludeTarget |= 1 << gameObject.layer;
        }
    }
```

- *if (excludeTarget != (excludeTarget | (1 << gameObject.layer)))*
  - ì˜ˆë¥¼ ë“¤ì–´ ë ˆì´ì–´ê°€ 8ê°€ì§€ë¼ë©´ 32bitì¤‘ 8bitì˜ ê°ê°ì˜ ìë¦¬ëŠ” ê° layerì— ëŒ€ì‘í•œë‹¤.
  - `(excludeTarget | (1 << gameObject.layer))`
    - gameObject, ì¦‰ `Player Character`ì˜ layer ì™€ `excludeTarget`ë¥¼ <u>í•©ì¹œ ê²ƒ</u> ğŸ‘‰ OR ì—°ì‚°
      - `(1 << gameObject.layer)`
        - 00000000000000000000000000000001 ì„ `gameObject.layer` ë§Œí¼, ì¦‰ í•´ë‹¹ ë ˆì´ì–´ì˜ ì¸ë±ìŠ¤ë§Œí¼ left-shift ì—°ì‚°ì„ í•œë‹¤.
          - ë¹„íŠ¸ ë‚´ì—ì„œ 1 ì„ í•´ë‹¹ ë ˆì´ì–´ì— ëŒ€ì‘ í•˜ëŠ” ìœ„ì¹˜ë§Œí¼ ì˜®ê¹€.
      - ì¡°ì¤€ ëŒ€ìƒì´ ì•„ë‹Œ ë ˆì´ì–´ë“¤ì˜ ë¹„íŠ¸ëŠ” 1ë¡œ ëª¨ì•„ë‘” `excludeTarget`ë¹„íŠ¸ì™€ *(1 << gameObject.layer)* ë¥¼ í•©ì³¤ì„ ë•Œ  `excludeTarget`ë¹„íŠ¸ì™€ ë‹¤ë¥´ë‹¤ë©´ ì¤‘ë³µë˜ì§€ ì•Šì€ ë ˆì´ì–´ë‹¤. 
        - ì¦‰, `gameObject.layer`ì€ `excludeTarget`ì— í¬í•¨ë˜ì§€ ì•Šì€ ë ˆì´ì–´ë‹¤.
          - ê·¸ë ‡ë‹¤ë©´ í¬í•¨ í•´ì„œ `excludeTarget`ì„ ê°±ì‹ í•´ì•¼ í•œë‹¤. 
            - *excludeTarget |= 1 << gameObject.layer;*
- ì´ê°™ì´ `excludeTarget`ì„ ë‘ëŠ” ì´ìœ 
  - í”Œë ˆì´ì–´ëŠ” í”Œë ˆì´ì–´ ìŠ¤ìŠ¤ë¡œë¥¼ ì˜ë©´ ì•ˆë˜ê¸° ë•Œë¬¸.

<br>

#### private void Start()

> ğŸ“œPlayerShooter ì—ì„œ ì‚¬ìš©í•  ì™¸ë¶€ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ê°€ì ¸ì˜´

```c#
    private void Start()
    {
        playerCamera = Camera.main;  // ë©”ì¸ ì¹´ë©”ë¼ ê°€ì ¸ì˜´
        playerInput = GetComponent<PlayerInput>(); 
        playerAnimator = GetComponent<Animator>();
    }
```

<br>

#### private void OnEnable()

> ğŸ“œPlayerShooterìŠ¤í¬ë¦½íŠ¸(ì»´í¬ë„ŒíŠ¸)ê°€ í™œì„±í™”ë˜ëŠ” ìˆœê°„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¨ìˆ˜

```c#
    private void OnEnable()
    {
        gun.gameObject.SetActive(true);
        gun.Setup(this);
    }
```

-  `Gun` ì˜¤ë¸Œì íŠ¸ë¥¼ í™œì„±í™” ì‹œí‚¤ê³  
- ğŸ“œGun.csì˜ Setup í•¨ìˆ˜ ì‹¤í–‰
  - ğŸ“œGun.csì˜ `gunHolder`ì™€ `excludeTarget`ë¥¼ ì´ˆê¸°í™”
  - `Gun`ì„ ì¥ê³ ìˆëŠ” Shooterê°€ ë‚˜ ìì‹ (`Player Character`)ì„ì„ ì¸ìˆ˜(`this`)ë¡œ ë„˜ê²¨ ì•Œë ¤ì¤€ë‹¤.

<br>

#### private void OnDisable()

> ğŸ“œPlayerShooter ìŠ¤í¬ë¦½íŠ¸(ì»´í¬ë„ŒíŠ¸)ê°€ ë¹„í™œì„±í™”ë˜ëŠ” ìˆœê°„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¨ìˆ˜

```c#
    private void OnDisable()
    {
        gun.gameObject.SetActive(false);
    }
```

- `Gun` ì˜¤ë¸Œì íŠ¸ë„ ê°™ì´ ë¹„í™œì„±í™” í•œë‹¤.

<br>

#### private void FixedUpdate()

> ê³ ì •ëœ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” Update ì´ë²¤íŠ¸ í•¨ìˆ˜ì¸ë§Œí¼ ë¬¼ë¦¬ì²˜ë¦¬ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•œë‹¤.

```c#
    private void FixedUpdate()
    {
        if (playerInput.fire)
        {
            Shoot();
        }
        else if (playerInput.reload)
        {
            Reload();
        }
    }
```

- ë§¤ ìˆœê°„ ê³ ì •ëœ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.
  - ì…ë ¥ì— ë”°ë¼ `fire` ìƒíƒœë¼ë©´ **Shoot()** í•¨ìˆ˜ ì‹¤í–‰ 
  - ì…ë ¥ì— ë”°ë¼ `reload` ìƒíƒœë¼ë©´ **Reload()** í•¨ìˆ˜ ì‹¤í–‰ 

<br>

#### private void Update()

```c#
    private void Update()
    {
        UpdateAimTarget();

        var angle = playerCamera.transform.eulerAngles.x;
        if (angle > 270f) angle -= 360f;

        angle = angle / 180f * -1f + 0.5f;

        playerAnimator.SetFloat("Angle", angle);

        UpdateUI();
    }
```

- **UpdateAimTarget()** í•¨ìˆ˜ë¥¼ ë§¤ í”„ë ˆì„ ì‹¤í–‰
  - `aimPoint` ê³„ì†í•´ì„œ ê°±ì‹ 

<br>

#### public void Shoot()

> `aimState`ì— ë”°ë¥¸ ë°œì‚¬ ì²˜ë¦¬

- `Gun`ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œë§Œ ë„£ìœ¼ë©´ ëœë‹¤.
  - ë°œì‚¬ ì²˜ë¦¬ì˜ ì„¸ë¶€ êµ¬í˜„ì€ ğŸ“œGun.cs ì—ì„œ êµ¬í˜†ë†“ìŒ.

```c#
    public void Shoot()
    {
        if (aimState == AimState.Idle)
        {
            if (linedUp) aimState = AimState.HipFire;
        }
        else if (aimState == AimState.HipFire)
        {
            if (hasEnoughDistance)
            {
                if (gun.Fire(aimPoint)) playerAnimator.SetTrigger("Shoot");
            }
            else
            {
                aimState = AimState.Idle;
            }
        }
    }

```

- ì—ì„ ìƒíƒœê°€ ë¬´ê¸°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” `Idle` ìƒíƒœì—ì„œ **Shoot** ì…ë ¥ì´ ë“¤ì–´ì˜¨ê±°ë¼ë©´
  - ì—ì„ ìƒíƒœë¥¼ ê²¬ì°© ì¡°ì¤€ ìƒíƒœ `HipFire`ë¡œ ë°”ê¾¸ì–´ ì£¼ì–´ì•¼ í•œë‹¤.
    - ë‹¨, `lineUp`ì´ trueì¼ë•Œ. ì¦‰, `Player Character`ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ê³¼ `playerCamera` ì¹´ë©”ë¼ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ ì‚¬ì´ì˜ y ì¶• íšŒì „ê°’ ì‚¬ì´ì˜ ê°ë„ê°€ 1 ë„ë¥¼ ë„˜ê¸°ì§€ ì•Šì„ ë•Œë§Œ.
    - ì¹´ë©”ë¼ì™€ í”Œë ˆì´ì–´ê°€ ê°™ì€ ë°©í–¥ìœ¼ë¡œ ì •ë ¬ì´ ë˜ì–´ ìˆì„ ë•Œë§Œ
- ì´ë¯¸ ê²¬ì°© ì¡°ì¤€ ìƒíƒœì˜€ë˜ `HipFire` ì—ì„œ **Shoot** ì…ë ¥ì´ ë“¤ì–´ì˜¨ê±°ë¼ë©´
  - `hasEnoughDistance`ì´ trueì¼ ë•Œ ì¦‰, ì´ì´ ì–´ë”” ë²½ê°™ì€ë° íŒŒë¬»í˜€ ìˆëŠ”ê²Œ ì•„ë‹ ë•Œë§Œ 
    - ê·¸ë¦¬ê³  ë°œì‚¬ê°€ ê°€ëŠ¥í•  ë•Œë§Œ ì¦‰, gun.Fire(aimPoint) ture ì¼ ë•Œë§Œ
      - í”Œë ˆì´ì–´ ì• ë‹ˆë©”ì´ì…˜ì˜ Triggerë¥¼ "Shoot" ìƒíƒœë¡œ ì„¤ì •.
  - `hasEnoughDistance`ì´ falseì¼ ë•Œ ì¦‰, ì´ì´ ì–´ë”” ë²½ê°™ì€ë° íŒŒë¬»í˜€ ìˆëŠ”ê±°ë¼ë©´ 
    - ì—ì„ ìƒíƒœë¥¼ `Idle` ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°.  

<br>

#### public void Reload()

```c#
    public void Reload()
    {
        // ì¬ì¥ì „ ì…ë ¥ ê°ì§€ì‹œ ì¬ì¥ì „
        if (gun.Reload()) playerAnimator.SetTrigger("Reload");
    }
```

- ì¬ì¥ì „ì´ ê°€ëŠ¥í•œ ìƒíƒœë¼ë©´, ì¦‰ *gun.Reload()*ê°€ true ë¦¬í„´
  - í”Œë ˆì´ì–´ ì• ë‹ˆë©”ì´ì…˜ì˜ Triggerë¥¼ "Reload" ìƒíƒœë¡œ ì„¤ì •.

<br>

#### private void UpdateAimTarget()

> `aimPoint`ì„ ë§¤ í”„ë ˆì„ë§ˆë‹¤ ê°±ì‹  

```c#
    private void UpdateAimTarget()
    {
        RaycastHit hit;

        var ray = playerCamera.ViewportPointToRay(new Vector3(0.5f, 0.5f, 0f));

        if (Physics.Raycast(ray, out hit, gun.fireDistance, ~excludeTarget))
        {
            aimPoint = hit.point;

            if (Physics.Linecast(gun.fireTransform.position, hit.point, out hit, ~excludeTarget))
            {
                aimPoint = hit.point;
            }
        }
        else
        {
            aimPoint = playerCamera.transform.position + playerCamera.transform.forward * gun.fireDistance; // ì•ìª½ ë°©í–¥ìœ¼ë¡œ ìµœëŒ€ ì‚¬ì • ê±°ë¦¬
        }
    }
```

![image](https://user-images.githubusercontent.com/42318591/90268844-9be09680-de92-11ea-8909-cc09a6b18695.png){: width="70%" height="70%"}{: .align-center}

- `ViewportPointToRay(Vecotr3)`
  - ì¹´ë©”ë¼ ì˜¤ë¸Œì íŠ¸ì— ë‚´ì¥ë˜ì–´ ìˆëŠ” í•¨ìˆ˜ë¡œì„œ
  - ì¹´ë©”ë¼ê°€ ì°ê³  ìˆëŠ” í™”ë©´(ë·°í¬íŠ¸)ìƒì˜ ìœ„ì¹˜ë¥¼ Vector3ë¡œ ë„˜ê¸°ë©´ ê·¸ í™”ë©´ ìƒ ìœ„ì¹˜ë¥¼ ê°€ë¡œì§€ë¥´ëŠ” `Ray`ë¥¼ ë¦¬í„´í•œë‹¤. 
  - position.z ëŠ” ë¬´ì‹œ ëœë‹¤. 
- *ray = playerCamera.ViewportPointToRay(new Vector3(0.5f, 0.5f, 0f));*
  - ì¹´ë©”ë¼ í™”ë©´ì˜ ì •ì¤‘ì•™ì„ ê°€ë¡œì§€ë¥´ëŠ” ê´‘ì„  `ray`
- ì¹´ë©”ë¼ í™”ë©´ì˜ ì •ì¤‘ì•™ì„ ê°€ë¡œì§€ë¥´ëŠ” ê´‘ì„ ì˜ ì¶©ëŒì´ ê°ì§€ ëœë‹¤ë©´ 
  - 1 ì°¨ë¡œ `aimPoint` ì—…ë°ì´íŠ¸. Raycast ì¶©ëŒ ì§€ì ì¸ `hit.point`ë¡œ ì—…ë°ì´íŠ¸
  - ë§Œì•½ ì´ëŸ° ìƒí™©ì—ì„œ ì´ì˜ ë°œì‚¬êµ¬(*gun.fireTransform.position*)ë¡œë¶€í„° ì¹´ë©”ë¼ í™”ë©´ì˜ ì •ì¤‘ì•™ì„ ê°€ë¡œì§€ë¥´ëŠ” ê´‘ì„ ì˜ ì¶©ëŒì§€ì (*hit.point*)ê¹Œì§€ì˜ Linecast ì—ì„œ ë­”ê°€ ì¶©ëŒë˜ëŠ”ê²Œ ìˆë‹¤ë©´!
    - ì‹¤ì œë¡œ ì¹´ë©”ë¼ í™”ë©´ì˜ ì •ì¤‘ì•™ì„ ê°€ë¡œì§€ë¥´ëŠ” ê´‘ì„ ì˜ ì¶©ëŒì§€ì ì„ ì¡°ì¤€ì ìœ¼ë¡œ ì‚¼ì•„ì•¼ í•˜ëŠ”ê²Œ ì•„ë‹Œ ê·¸ Linecast ì¶©ëŒ ì§€ì ì„ `aimPoint`ë¡œ ì¡ì•„ì•¼ í•œë‹¤.
      - 2 ì°¨ë¡œ `aimPoint` ì—…ë°ì´íŠ¸. Linecast ì¶©ëŒ ì§€ì ì¸ `hit.point`ë¡œ ì—…ë°ì´íŠ¸
- ì¹´ë©”ë¼ í™”ë©´ì˜ ì •ì¤‘ì•™ì„ ê°€ë¡œì§€ë¥´ëŠ” ê´‘ì„ ì— ì•„ë¬´ê²ƒë„ ì¶©ëŒë˜ëŠ”ê²Œ ì—†ë‹¤ë©´
  - ì¡°ì¤€ì  `aimPoint`ë¥¼ `playerCamera`ì˜ ìœ„ì¹˜ë¡œë¶€í„° (`playerCamera` ì•ìª½ ë°©í–¥ X ì´ì•Œì˜ ìµœëŒ€ ì‚¬ì • ê±°ë¦¬) ë§Œí¼ ë”í•´ì¤€ ê³³(ë²¡í„°)ë¡œ ì¡ëŠ”ë‹¤. 

<br>

#### private void UpdateUI()

```c#
    private void UpdateUI()
    {
        if (gun == null || UIManager.Instance == null) return;

        // UI ë§¤ë‹ˆì €ì˜ íƒ„ì•½ í…ìŠ¤íŠ¸ì— íƒ„ì°½ì˜ íƒ„ì•½ê³¼ ë‚¨ì€ ì „ì²´ íƒ„ì•½ì„ í‘œì‹œ
        UIManager.Instance.UpdateAmmoText(gun.magAmmo, gun.ammoRemain);

        UIManager.Instance.SetActiveCrosshair(hasEnoughDistance);
        UIManager.Instance.UpdateCrossHairPosition(aimPoint);
    }
```

<br>

#### private void OnAnimatorIK(int layerIndex)

```c#
    private void OnAnimatorIK(int layerIndex)
    {
        if (gun == null || gun.state == Gun.State.Reloading) return;

        // IKë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¼ì†ì˜ ìœ„ì¹˜ì™€ íšŒì „ì„ ì´ì˜ ì˜¤ë¥¸ìª½ ì†ì¡ì´ì— ë§ì¶˜ë‹¤
        playerAnimator.SetIKPositionWeight(AvatarIKGoal.LeftHand, 1.0f);
        playerAnimator.SetIKRotationWeight(AvatarIKGoal.LeftHand, 1.0f);

        playerAnimator.SetIKPosition(AvatarIKGoal.LeftHand, gun.leftHandMount.position);
        playerAnimator.SetIKRotation(AvatarIKGoal.LeftHand, gun.leftHandMount.rotation);
    }
```

<br>

***
<br>

    ğŸŒœ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° 
    ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}

<br>